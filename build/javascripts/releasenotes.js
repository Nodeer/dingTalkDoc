/*
*	Copyright, Cedric Dugas,
*	Do not sell or redistribute
*/
!function(e){marked.setOptions({gfm:!0,pedantic:!1,sanitize:!0});var t={milestonesShown:10,phpApi:!1,phpApiPath:"/",showDescription:!0,showComments:!0,repo:"appstore",username:"ddtalk"};e.fn.releaseNotes=function(n){n=e.extend({},t,n||{});var a=n.phpApiPath+"api.php",i=n.phpApi?"json":"jsonp",o={load:function(t){var s=this;this.$el=e(t),this.loadEvents();var a=e.extend(n,{state:"closed",action:"milestones",sort:"due_date"});this.callApi(a).success(function(e){e.data&&(e=e.data),s.showMilestones(e)}).error(function(e){console.log(e)})},loadEvents:function(){var e=this;n.showDescription&&this.$el.delegate(".issue","click",function(){return e.loadIssueDesc(this),!1}),n.showComments&&this.$el.delegate(".btnComments","click",function(){return e.loadComments(this),!1})},loadIssueDesc:function(t){var a=e(t),i=a.data("issue");$bigIssue=a.find(".issueBig"),$bigIssue.is(":visible")?$bigIssue.slideUp():(e(".issueBig").not($bigIssue).slideUp(),$bigIssue.find(".container").html(s.bigIssue(i,n.showComments)),$bigIssue.slideDown())},showMilestones:function(t){var a=this;t.sort(this.sortDate),e.each(t,function(t,i){if(t==n.milestonesShown)return!1;i.prettyDate=a.getPrettyDate(i.due_on?i.due_on:i.created_at),a.$el.append(s.milestone(i));var o=e.extend(n,{milestone:i.number,sort:"created",action:"issues",state:"closed"});a.callApi(o).success(function(e){e.data&&(e=e.data),a.showIssues(e)})})},loadComments:function(t){var s=this,a=e(t).attr("data-issue-id");e(t).fadeOut().slideUp();var i=e.extend(n,{issueid:a,action:"comments"});this.callApi(i).success(function(e){e.data&&(e=e.data),s.showComments(e,a)})},showComments:function(t,n){var a=this,i=a.$el.find("#issue"+n).find(".comments").empty();e.each(t,function(e,t){t.prettyDate=a.getPrettyDate(t.created_at),i.append(s.comment(t,n))}),i.slideDown()},showIssues:function(t){var a=this,i=a.$el.find("[data-id-milestone="+t[0].milestone.number+"]"),o=i.find(".issues");t.sort(this.sortLabel),e.each(t,function(e,t){t.prettyDate=a.getPrettyDate(t.closed_at),o.append(s.issue(t))}),i.addClass("separator"),n.showDescription&&i.find(".issue").addClass("cursor")},getPrettyDate:function(e){var t="",e=e.split("T"),s=e[0].split("-"),n=new Date(s[0],s[1]-1,s[2]),a=new Array("Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"),i=new Array("January","February","March","April","May","June","July","August","September","October","November","December");return t+=a[n.getDay()]+", ",t+=i[n.getMonth()]+" ",t+=n.getDate()+", ",t+=n.getFullYear()},sortDate:function(e,t){e.dateTest=e.due_on?e.due_on:e.created_at,t.dateTest=t.due_on?t.due_on:t.created_at;var s=new Date(e.dateTest),n=new Date(t.dateTest);return n>s?1:s>n?-1:0},sortLabel:function(e,t){return e.labels.length?t.labels.length?e.labels[0].name>t.labels[0].name?1:e.labels[0].name<t.labels[0].name?-1:0:-1:1},callApi:function(t){var s=e.extend({},t);return s.repo&&delete s.repo,e.ajax({url:this.urls[t.action](t),dataType:i,data:s})},urls:{domainName:"https://api.github.com",milestones:function(){return n.phpApi?a:$url=this.domainName+"/repos/"+n.username+"/"+n.repo+"/milestones"},issues:function(){return n.phpApi?a:$url=this.domainName+"/repos/"+n.username+"/"+n.repo+"/issues"},comments:function(e){return n.phpApi?a:$url=this.domainName+"/repos/"+n.username+"/"+n.repo+"/issues/"+e.issueid+"/comments"}}};return this.each(function(){o.load(this,n)})};var s={milestone:function(t){return e('<div data-id-milestone="'+t.number+'" class="milestoneContainer">    			        <h3 class="release">'+t.title+'</h3>			        <p class="dateRelease">\u53d1\u5e03\u65e5\u671f: '+t.prettyDate+'</p>			        <div class="issues"></div>			  </div>').data("milestone",t)},issue:function(t){var s="",n=this;return e.each(t.labels,function(e,t){s+=n.label(t)}),null!==t.body&&void 0!==t.body&&""!==t.body&&"#"==t.body.substring(0,1)?e('<div id="issue'+t.number+'" >				<ul >					<li><p><a href="'+t.body+'">'+s+" "+e("<span>").html(t.title).text()+" </a></p></li>				</ul>				").data("issue",t):e('<div id="issue'+t.number+'" >				<ul >					<li><p>'+s+" "+e("<span>").html(t.title).text()+"</p></li>				</ul>				").data("issue",t)},label:function(e){return"<span >"+e.name+"</span>"},bigIssue:function(){},comment:function(){}}}(jQuery);